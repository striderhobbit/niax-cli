<app-resource-table-settings
  (columnsChange)="updateResourceTableColumns()"
  [resourceTable]="resourceTable"
  #resourceTableSettingsComponent
></app-resource-table-settings>
<button mat-icon-button (click)="resourceTableSettingsComponent.toggle()">
  <mat-icon>
    unfold{{ resourceTableSettingsComponent.isVisible ? "_less" : "_more" }}
  </mat-icon>
</button>
<table
  *ngIf="paths"
  (cdkDropListDropped)="onPathDropped($event)"
  [cdkDropListData]="paths"
  [dataSource]="dataSource"
  cdkDropList
  cdkDropListLockAxis="x"
  cdkDropListOrientation="horizontal"
  mat-table
>
  <ng-container
    *ngFor="let column of resourceTable.columns | filter : 'include'"
    [matColumnDef]="column.path"
  >
    <th *matHeaderCellDef [cdkDragData]="column.path" cdkDrag mat-header-cell>
      <mat-form-field>
        <input
          (change)="updateResourceTableColumns()"
          (ngModelChange)="columnFilter.invalid || (column.filter = $event)"
          [ngModel]="column.filter"
          #columnFilter="ngModel"
          matInput
          pattern="[^,]*"
          placeholder="/(?:)/"
          type="text"
          validateRegExp
        />
        <mat-label>{{ column.path }}</mat-label>
        <mat-icon matSuffix>filter_alt</mat-icon>
        <mat-error *ngIf="columnFilter.errors?.['syntax'] as syntaxError">
          {{ syntaxError }}
        </mat-error>
        <mat-error *ngIf="columnFilter.errors?.['pattern'] as patternError">
          Required pattern: {{ patternError.requiredPattern }}
        </mat-error>
      </mat-form-field>
    </th>
    <td *matCellDef="let row" mat-cell>
      {{ row.fields[column.path].value }}
    </td>
  </ng-container>

  <ng-container matColumnDef="placeholder">
    <td
      *matCellDef="let placeholder"
      (intersection)="fetchResourceTableRows(placeholder.pageToken)"
      [colSpan]="paths.length"
      mat-cell
      observeIntersection
    >
      <mat-icon>more_horiz</mat-icon>
    </td>
  </ng-container>

  <tr *matHeaderRowDef="paths" mat-header-row></tr>

  <tr *matRowDef="let row; columns: paths" mat-row></tr>
  <tr
    *matRowDef="let row; columns: ['placeholder']; when: isPlaceholder"
    mat-row
  ></tr>
</table>
