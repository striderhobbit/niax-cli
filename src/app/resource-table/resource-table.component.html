<table
  *ngIf="
    resourceTable.primaryPaths.concat(resourceTable.secondaryPaths) as paths
  "
  (cdkDropListDropped)="moveResourceTableColumns($event)"
  [cdkDropListData]="paths"
  [dataSource]="dataSource"
  cdkDropList
  cdkDropListLockAxis="x"
  cdkDropListOrientation="horizontal"
  mat-table
>
  <ng-container *ngIf="['select', 'index'].concat(paths) as columns">
    <ng-container matColumnDef="select" sticky>
      <th *matHeaderCellDef mat-header-cell></th>
      <td *matCellDef="let row" mat-cell>
        <mat-checkbox
          *ngIf="assertIsResourceTableRow(row) as row"
          (change)="toggleRowIsSelected(row)"
          [checked]="selection.isSelected(row)"
        >
        </mat-checkbox>
      </td>
      <td *matFooterCellDef mat-footer-cell>
        <ng-container *ngIf="selection.selected[0] as selection">
          <button
            *ngIf="assertIsResourceTableRow(selection) as row"
            (click)="scrollToAnchor(row.resource.id)"
            mat-icon-button
          >
            <mat-icon>north</mat-icon>
          </button>
        </ng-container>
        <button
          (click)="intersectionIgnored = !intersectionIgnored"
          mat-icon-button
        >
          <mat-icon>timer{{ intersectionIgnored ? "_off" : "" }}</mat-icon>
        </button>
      </td>
    </ng-container>

    <ng-container matColumnDef="index" sticky>
      <th *matHeaderCellDef mat-header-cell></th>
      <td *matCellDef="let row" mat-cell>
        <ng-container *ngIf="assertIsResourceTableRow(row) as row">
          <a [name]="row.resource.id"></a>
          {{ row.index + 1 }}
        </ng-container>
      </td>
      <td *matFooterCellDef mat-footer-cell>
        <mat-form-field>
          <mat-label>Page size</mat-label>
          <mat-select
            (ngModelChange)="
              setQueryParams({ limit: $event }, { runResolvers: true })
            "
            [ngModel]="resourceTable.query.limit"
          >
            <mat-option
              *ngFor="let pageSize of [10, 25, 50]"
              [value]="pageSize"
            >
              {{ pageSize }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </td>
    </ng-container>

    <ng-container
      *ngFor="let column of resourceTable.columns | filter : 'include'"
      [matColumnDef]="column.path"
    >
      <th *matHeaderCellDef mat-header-cell>
        <b>{{ column.path }}</b>
      </th>
      <td *matCellDef="let row" mat-cell>
        <ng-container *ngIf="assertIsResourceTableRow(row) as row">
          <ng-container *ngIf="row.fields[column.path] as field">
            <div>{{ field.value }}</div>
            <button
              (click)="openResourceItemPatchDialog(field)"
              mat-icon-button
            >
              <mat-icon>edit_note</mat-icon>
            </button>
          </ng-container>
        </ng-container>
      </td>
      <td *matFooterCellDef [cdkDragData]="column.path" cdkDrag mat-footer-cell>
        <mat-form-field>
          <input
            (change)="updateResourceTableColumns()"
            (ngModelChange)="columnFilter.invalid || (column.filter = $event)"
            [ngModel]="column.filter"
            #columnFilter="ngModel"
            matInput
            pattern="[^,]*"
            placeholder="/(?:)/"
            type="text"
            validateRegExp
          />
          <mat-label>{{ column.path }}</mat-label>
          <button
            (click)="column.filter = ''; updateResourceTableColumns()"
            [disabled]="!column.filter"
            mat-icon-button
            matSuffix
          >
            <mat-icon>filter_alt{{ column.filter && "_off" }}</mat-icon>
          </button>
          <mat-error *ngIf="columnFilter.errors?.['syntax'] as syntaxError">
            {{ syntaxError }}
          </mat-error>
          <mat-error *ngIf="columnFilter.errors?.['pattern'] as patternError">
            Required pattern: {{ patternError.requiredPattern }}
          </mat-error>
        </mat-form-field>
        <button
          *ngIf="column.sortIndex != null"
          (click)="
            column.order = column.order === 'desc' ? '' : 'desc';
            updateResourceTableColumns()
          "
          mat-icon-button
        >
          <mat-icon>{{ column.order === "desc" ? "north" : "south" }}</mat-icon>
        </button>
        <button [matMenuTriggerFor]="menu" mat-icon-button>
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #menu>
          <button
            *ngIf="column.sortIndex != null"
            (click)="
              pull(resourceTable.primaryPaths, column.path);
              syncResourceTableColumns()
            "
            mat-menu-item
          >
            Disable sort
          </button>
          <button
            *ngIf="column.sortIndex == null"
            (click)="
              resourceTable.primaryPaths.push(column.path);
              syncResourceTableColumns()
            "
            mat-menu-item
          >
            Sort ascending
          </button>
          <button
            *ngIf="column.sortIndex == null"
            (click)="
              column.order = 'desc';
              resourceTable.primaryPaths.push(column.path);
              syncResourceTableColumns()
            "
            mat-menu-item
          >
            Sort descending
          </button>
          <button (click)="openColumnToggleDialog()" mat-menu-item>
            Toggle...
          </button>
        </mat-menu>
      </td>
    </ng-container>

    <ng-container matColumnDef="placeholder">
      <td
        *matCellDef="let placeholder"
        (intersection)="fetchResourceTableRows(placeholder.pageToken)"
        [colSpan]="columns.length"
        [intersectionIgnored]="intersectionIgnored"
        mat-cell
        observeIntersection
      >
        <button
          (click)="fetchResourceTableRows(placeholder.pageToken)"
          [disabled]="!intersectionIgnored"
          mat-button
        >
          <mat-icon svgIcon="dashArray"></mat-icon>
        </button>
      </td>
    </ng-container>

    <ng-container matColumnDef="query">
      <td *matFooterCellDef [colSpan]="columns.length" mat-footer-cell>
        <div *ngFor="let entry of resourceTable.signature | keyvalue">
          {{ entry.key }}: {{ entry.value }}
        </div>
      </td>
    </ng-container>

    <tr *matHeaderRowDef="columns" mat-header-row></tr>

    <tr
      *matRowDef="let row; columns: columns"
      (viewInit)="$event.scrollIntoView({ block: 'start' })"
      [viewInitIgnored]="
        assertIsResourceTableRow(row).resource.id !==
        resourceTable.query.resourceId
      "
      mat-row
      observeViewInit
    ></tr>

    <tr
      *matRowDef="let row; columns: ['placeholder']; when: isPlaceholder"
      mat-row
    ></tr>

    <tr *matNoDataRow>
      <td [attr.colspan]="columns.length">No data</td>
    </tr>

    <tr *matFooterRowDef="columns; sticky: true" mat-footer-row></tr>
    <tr *matFooterRowDef="['query']; sticky: true" mat-footer-row></tr>
  </ng-container>
</table>
